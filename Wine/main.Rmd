---
title: "G53FIV Coursework | PSYCX1 - 14331485"
output:
    pdf_document:
      latex_engine: xelatex
      includes:
        in_header: preamble.tex
      number_sections: true
geometry: "left=1.5cm,right=1.5cm,top=2cm,bottom=2cm"
classoption: twocolumn
header-includes:
    - \usepackage{charter} % Font
    - \setlength{\columnsep}{1cm}
    - \usepackage{booktabs}
    - \usepackage{sectsty} \sectionfont{\centering}
    - \usepackage{biblatex}
    - \addbibresource{bib.bib}
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = TRUE,
	include = FALSE
)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(ggridges)
library(here)
library(naniar)
library(countrycode)
library(stringr)
theme_set(theme_bw())
```

```{r load_data, include=FALSE}
df_raw_1 <- as_tibble(read_csv("data/wine_new.csv"))
df_raw_2 <- as_tibble(read_csv("data/wine.csv"))

df_2 <- select(df_raw_2, -c(X1, description, province, region_1, region_2,
                            taster_twitter_handle)) %>% 
  mutate(vintage = str_match(title, "([1|2][0-9]{3})")[,1])

df_1 <- select(df_raw_1, -c(description, province, region_1, region_2,
                            taster_twitter_handle, taster_photo)) %>% 
  relocate(vintage, .after = last_col())

df <- df_1 %>% add_row(df_2) %>% distinct(title, .keep_all=TRUE) %>% 
  mutate(taster_name = gsub("\u00A0", " ", taster_name, fixed = TRUE)) %>% 
  mutate(taster_name = gsub("â€™", "\'", taster_name))

df$continent <- countrycode(sourcevar = pull(df, country),
                            origin = "country.name",
                            destination = "continent")

POINT_SIZE <-  3.5

# country = col_character(),
# designation = col_character(),
# points = col_double(),
# price = col_double(),
# province = col_character(),
# region_1 = col_character(),
# region_2 = col_character(),
# taster_name = col_character(), 
# taster_twitter_handle = col_character(),
# title = col_character(),
# variety = col_character(),
# winery = col_character()
```


```{r}
p_d <- ggplot(df)
p_d + geom_density(aes(x = log(price)))
p_d + geom_bar(aes(x = points))
```

### QUESTION 1
```{r}
df_q1 <- df %>% group_by(country, continent) %>%
  count(name = 'count') %>%
  drop_na(country, count) %>%  
  ungroup() %>% 
  slice_max(count, n = 10)

p <- ggplot(df_q1, aes(x = count, y = reorder(country, count), color = continent))
p + geom_point(size=POINT_SIZE) +
  xlim(-500, 80500) + 
  labs(x = 'Count', y = NULL, color = 'Continent') + 
  theme(legend.position = "top")

ggsave('1.jpg', width = 9, height = 6, scale = 0.75)

### END OF QUESTION 1
```

### QUESTION 2
```{r}
df_q2 <- df %>% 
  group_by(country, continent) %>%
  summarize(points_mean = mean(points, na.rm = TRUE),
            points_sd = sd(points, na.rm = TRUE),
            count = n()) %>% 
  drop_na(country) %>% 
  ungroup() %>%
  slice_max(count, n=10)

p <- ggplot(df_q2, aes(x = points_mean,
                       y = reorder(country, points_mean),
                       color = continent)) # CLEVELAND DOT PLOT

p + geom_pointrange(aes(xmin = points_mean - points_sd,
                        xmax = points_mean + points_sd),
                    alpha=0.30,
                    size = 1.75,
                    fatten = 0.01,
                    show.legend = FALSE) +
  geom_point(size = POINT_SIZE) +
  scale_x_continuous(limits = c(83,95), expand = c(0,0.5), breaks = scales::pretty_breaks(n = 8)) +
  labs(x = 'Points', y = NULL, color = 'Continent') + 
  theme(legend.position = "top")

ggsave('2.jpg', width = 10, height = 6, scale = 0.75)

### END OF QUESTION 2
```


```{r}
df_genders <- as_tibble(read_csv('data/taster_genders.csv'))

df_q4 <- df %>% group_by(taster_name) %>%
  summarize(points_mean = mean(points, na.rm = TRUE),
            points_sd = sd(points, na.rm = TRUE),
            count = n()) %>%  
  drop_na(taster_name)

df_joined <- left_join(df_q4, df_genders, by='taster_name')

p <- ggplot(df_joined, aes(x = points_mean, y = reorder(taster_name, points_mean), color=gender))
p + geom_pointrange(aes(xmin = points_mean - points_sd,
                        xmax = points_mean + points_sd),
                    alpha=0.35,
                    size = 1,
                    fatten = 0.01,
                    show.legend = FALSE) + 
  geom_point() + 
  scale_x_continuous(limits = c(83,95), expand = c(0,0.5), breaks = scales::pretty_breaks(n = 8)) +
  labs(x = 'Points', y = NULL, color = 'Gender') +  
  theme(legend.position = "top")

ggsave('3.jpg', scale=0.75)
```

```{r}
p <- ggplot(df, aes(x = points, y = taster_name))
p + geom_violin()
```   


```{r}
df_q2 <- df %>% drop_na(country, points) %>%
  group_by(country) %>% 
  summarise(n = n()) %>%
  top_n(10) %>%
  left_join(df, by = "country")

p <- ggplot(df_q2, aes(x = points, y = country))
p + geom_boxplot()
```

## Is price correlated with points?
```{r, fig.width=8}
p <- ggplot(df, aes(points, log10(price)))
# p + geom_point(alpha=0.1) + geom_smooth()
# p + geom_boxplot(aes(group=points))
p + geom_violin(aes(group=points))
```


### QUESTION 3
```{r, fig.height=8, fig.width=8}
q3 <- df %>% select(c(price, points))
  
p3 <- ggplot(q3, aes(x = price,
                     y = factor(points),
                     fill = ..x..))

p3 + geom_density_ridges_gradient(scale = 1.75,
                                 size = 0.25,
                                 rel_min_height = 0.01,
                                 quantile_lines=TRUE, quantile_fun=function(x,...)median(x)) +
  scale_fill_viridis_c(name = 'Log Price', option = 'D') +
  scale_x_log10(labels = scales::dollar, expand = c(0, 0)) +
  guides(fill=FALSE) + 
  labs(x = 'Price', y = 'Points')

ggsave('4.jpg', scale=0.75)
### END OF QUESTION 3
```

